<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Time Forum</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- <link rel="stylesheet" href="styles.css"> -->
</head>
<body class="bg-gray-100">
    <!-- Navbar -->
    <nav id="navbar" class="bg-blue-500 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="text-white text-xl font-bold">Real Time Forum</div>
            <div id="nav-links" class="space-x-4"></div>
        </div>
    </nav>
    <!-- Main Content -->
    <div class="flex">
        <!-- Sidebar (visible for authenticated users) -->
        <div id="sidebar" class="w-1/4 bg-white p-4 hidden">
            <h3 class="text-lg font-bold mb-4">Users</h3>
            <div id="user-list"></div>
        </div>
        <!-- App Content -->
        <div id="app" class="flex-grow container mx-auto p-4"></div>
    </div>
    <!-- MessageWebSocket.js -->
    <script src="js/ws-client.js"></script>
    <!-- Main App Script -->
    <script>
        // State
        let token = localStorage.getItem('token');
        let userId = '123'; // Default; updated after login/signup
        let nickname = ''; // Set after login/signup
        let ws = null;
        let selectedChatUserId = null; // For Messages page
        let messageOffset = 0; // For pagination
        let isLoadingMessages = false;

        // Throttle function for scroll
        function throttle(fn, wait) {
            let lastCall = 0;
            return function (...args) {
                const now = Date.now();
                if (now - lastCall >= wait) {
                    lastCall = now;
                    return fn(...args);
                }
            };
        }

        // Router
        const routes = {
            '/login': {
                template: `
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="bg-white p-8 rounded shadow-md w-full max-w-md">
                            <h2 class="text-2xl font-bold mb-6 text-center">Login</h2>
                            <div id="login-error" class="text-red-500 mb-4 hidden"></div>
                            <div>
                                <input id="login" type="text" placeholder="Nickname or Email" class="w-full p-2 mb-4 border rounded">
                                <input id="password" type="password" placeholder="Password" class="w-full p-2 mb-4 border rounded">
                                <button id="login-btn" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Login</button>
                            </div>
                        </div>
                    </div>
                `,
                init: () => {
                    document.getElementById('login-btn').addEventListener('click', async () => {
                        const login = document.getElementById('login').value;
                        const password = document.getElementById('password').value;
                        const errorEl = document.getElementById('login-error');
                        try {
                            const response = await fetch('/api/auth/login', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ login, password }),
                            });
                            const data = await response.json();
                            if (response.ok) {
                                token = data.token;
                                localStorage.setItem('token', token);
                                try {
                                    const payload = JSON.parse(atob(token.split('.')[1]));
                                    userId = payload.user_id;
                                    nickname = payload.nickname;
                                } catch (err) {
                                    console.error('Error decoding JWT:', err);
                                }
                                ws = new MessageWebSocket(userId);
                                navigate('/home');
                            } else {
                                errorEl.textContent = data.message || 'Login failed';
                                errorEl.classList.remove('hidden');
                            }
                        } catch (err) {
                            errorEl.textContent = 'Network error';
                            errorEl.classList.remove('hidden');
                        }
                    });
                }
            },
            '/signup': {
    template: `
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white p-8 rounded shadow-md w-full max-w-md">
                <h2 class="text-2xl font-bold mb-6 text-center">Sign Up</h2>
                <div id="signup-error" class="text-red-500 mb-4 hidden"></div>
                <div>
                    <input id="nickname" type="text" placeholder="Nickname" class="w-full p-2 mb-4 border rounded">
                    <input id="age" type="number" placeholder="Age" class="w-full p-2 mb-4 border rounded">
                    <select id="gender" class="w-full p-2 mb-4 border rounded">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                    <input id="first_name" type="text" placeholder="First Name" class="w-full p-2 mb-4 border rounded">
                    <input id="last_name" type="text" placeholder="Last Name" class="w-full p-2 mb-4 border rounded">
                    <input id="email" type="email" placeholder="Email" class="w-full p-2 mb-4 border rounded">
                    <input id="password" type="password" placeholder="Password" class="w-full p-2 mb-4 border rounded">
                    <button id="signup-btn" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Sign Up</button>
                </div>
            </div>
        </div>
    `,
    init: () => {
        document.getElementById('signup-btn').addEventListener('click', async () => {
            const nickname = document.getElementById('nickname').value.trim();
            const age = document.getElementById('age').value;
            const gender = document.getElementById('gender').value;
            const firstName = document.getElementById('first_name').value.trim(); // Use camelCase in payload
            const lastName = document.getElementById('last_name').value.trim();   // Use camelCase in payload
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorEl = document.getElementById('signup-error');

            // Validate inputs
            if (!nickname || !age || !gender || !firstName || !lastName || !email || !password) {
                errorEl.textContent = 'All fields are required.';
                errorEl.classList.remove('hidden');
                return;
            }
            if (!/^\d+$/.test(age) || parseInt(age) < 1) {
                errorEl.textContent = 'Please enter a valid age.';
                errorEl.classList.remove('hidden');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                errorEl.textContent = 'Please enter a valid email address.';
                errorEl.classList.remove('hidden');
                return;
            }

            // Prepare payload
            const payload = {
                nickname,
                age: parseInt(age),
                gender,
                firstName,
                lastName,
                email,
                password
            };
            console.log('Sending payload:', JSON.stringify(payload, null, 2)); // Debug log

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await response.json();
                if (response.ok) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        userId = payload.user_id || '123';
                        nickname = payload.nickname || 'User';
                    } catch (err) {
                        console.error('Error decoding JWT:', err);
                    }
                    ws = new MessageWebSocket(userId);
                    navigate('/home');
                } else {
                    errorEl.textContent = data.message || 'Sign Up failed';
                    errorEl.classList.remove('hidden');
                }
            } catch (err) {
                let errorMessage = 'Network error: Failed to process the signup request.\n';
                errorMessage += `Status: ${response?.status || 'Unknown'}\n`;
                errorMessage += `Content-Type: ${response?.headers?.get('Content-Type') || 'Unknown'}\n`;
                try {
                    const text = await response?.text();
                    errorMessage += `Response: ${text.slice(0, 100)}... (truncated)\n`;
                    if (text.includes('<!DOCTYPE html>')) {
                        errorMessage += 'Cause: The server returned HTML instead of JSON. This usually means the endpoint (/api/auth/register) is incorrect or the server is misconfigured.\n';
                    }
                } catch (textErr) {
                    errorMessage += 'Response: Unable to read response body\n';
                }
                errorMessage += 'Suggestions:\n';
                errorMessage += '- Check if the backend server is running and the /api/auth/register endpoint is correctly configured.\n';
                errorMessage += '- Ensure the request body matches the expected format (e.g., correct field names and types).\n';
                errorMessage += '- Verify CORS settings if the frontend and backend are on different origins.\n';
                errorMessage += '- Check the browser Console and Network tab for more details.';
                errorEl.textContent = errorMessage;
                errorEl.classList.remove('hidden');
                console.error('Signup error:', err, errorMessage);
            }
        });
    }
},
            '/home': {
                template: `
                    <h2 class="text-3xl font-bold mb-4">Welcome to the Forum App</h2>
                    <p class="text-lg">Explore posts, messages, and connect with others.</p>
                `,
                protected: true
            },
            '/posts': {
                template: `
                    <h2 class="text-2xl font-bold mb-4">Posts</h2>
                    <div class="mb-4">
                        <input id="post-title" type="text" placeholder="Post Title" class="w-full p-2 mb-4 border rounded">
                        <textarea id="post-content" placeholder="Write a post..." class="w-full p-2 mb-4 border rounded"></textarea>
                        <select id="post-category" class="w-full p-2 mb-4 border rounded">
                            <option value="General">General</option>
                            <option value="Tech">Tech</option>
                            <option value="News">News</option>
                        </select>
                        <button id="post-btn" class="mt-2 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Create Post</button>
                    </div>
                    <div id="posts-container"></div>
                `,
                protected: true,
                init: async () => {
                    const fetchPosts = async () => {
                        try {
                            const response = await fetch('/api/posts', {
                                headers: { 'Authorization': `Bearer ${token}` },
                            });
                            const posts = await response.json();
                            const container = document.getElementById('posts-container');
                            container.innerHTML = posts.map(post => `
                                <div class="p-4 mb-4 bg-white rounded shadow">
                                    <h3 class="text-xl font-bold"><a href="/posts/${post.id}" class="hover:underline">${post.title}</a></h3>
                                    <p>${post.content}</p>
                                    <p class="text-sm text-gray-500">
                                        By ${post.author_nickname} | ${post.category} | ${new Date(post.created_at).toLocaleString()}
                                    </p>
                                </div>
                            `).join('');
                        } catch (err) {
                            console.error('Error fetching posts:', err);
                        }
                    };

                    await fetchPosts();

                    document.getElementById('post-btn').addEventListener('click', async () => {
                        const title = document.getElementById('post-title').value;
                        const content = document.getElementById('post-content').value;
                        const category = document.getElementById('post-category').value;
                        if (!title.trim() || !content.trim()) return;
                        try {
                            const response = await fetch('/api/posts', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`,
                                },
                                body: JSON.stringify({ title, content, category }),
                            });
                            if (response.ok) {
                                document.getElementById('post-title').value = '';
                                document.getElementById('post-content').value = '';
                                await fetchPosts();
                            }
                        } catch (err) {
                            console.error('Error creating post:', err);
                        }
                    });
                }
            },
            '/posts/:id': {
                template: `
                    <div id="post-detail"></div>
                    <h3 class="text-lg font-bold mt-6 mb-4">Comments</h3>
                    <div id="comments-container"></div>
                    <div class="mt-4">
                        <textarea id="comment-content" placeholder="Write a comment..." class="w-full p-2 mb-4 border rounded"></textarea>
                        <button id="comment-btn" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Add Comment</button>
                    </div>
                `,
                protected: true,
                init: async () => {
                    const postId = window.location.pathname.split('/').pop();
                    const fetchPost = async () => {
                        try {
                            const response = await fetch(`/api/posts/${postId}`, {
                                headers: { 'Authorization': `Bearer ${token}` },
                            });
                            const post = await response.json();
                            const postEl = document.getElementById('post-detail');
                            postEl.innerHTML = `
                                <h2 class="text-2xl font-bold mb-4">${post.title}</h2>
                                <p>${post.content}</p>
                                <p class="text-sm text-gray-500">
                                    By ${post.author_nickname} | ${post.category} | ${new Date(post.created_at).toLocaleString()}
                                </p>
                            `;
                            const commentsEl = document.getElementById('comments-container');
                            commentsEl.innerHTML = post.comments.map(comment => `
                                <div class="p-4 mb-4 bg-gray-100 rounded">
                                    <p>${comment.content}</p>
                                    <p class="text-sm text-gray-500">
                                        By ${comment.author_nickname} | ${new Date(comment.created_at).toLocaleString()}
                                    </p>
                                </div>
                            `).join('');
                        } catch (err) {
                            console.error('Error fetching post:', err);
                        }
                    };

                    await fetchPost();

                    document.getElementById('comment-btn').addEventListener('click', async () => {
                        const content = document.getElementById('comment-content').value;
                        if (!content.trim()) return;
                        try {
                            const response = await fetch(`/api/posts/${postId}/comments`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`,
                                },
                                body: JSON.stringify({ content }),
                            });
                            if (response.ok) {
                                document.getElementById('comment-content').value = '';
                                await fetchPost();
                            }
                        } catch (err) {
                            console.error('Error adding comment:', err);
                        }
                    });
                }
            },
            '/messages': {
                template: `
                    <h2 class="text-2xl font-bold mb-4">Messages</h2>
                    <div id="message-container" class="mb-4"></div>
                    <div class="flex">
                        <input id="message-input" type="text" placeholder="Type a message..." class="flex-grow p-2 border rounded-l">
                        <button id="send-message-btn" class="bg-blue-500 text-white p-2 rounded-r hover:bg-blue-600">Send</button>
                    </div>
                `,
                protected: true,
                init: () => {
                    const container = document.getElementById('message-container');
                    const loadMessages = async () => {
                        if (!selectedChatUserId || isLoadingMessages) return;
                        isLoadingMessages = true;
                        try {
                            const response = await fetch(`/api/messages/${selectedChatUserId}?offset=${messageOffset}`, {
                                headers: { 'Authorization': `Bearer ${token}` },
                            });
                            const messages = await response.json();
                            const fragment = document.createDocumentFragment();
                            messages.forEach(msg => {
                                const messageEl = document.createElement('div');
                                messageEl.className = 'message';
                                messageEl.innerHTML = `
                                    <div class="message-sender">${msg.sender_nickname}</div>
                                    <div class="message-content">${msg.content}</div>
                                    <div class="message-timestamp">${new Date(msg.timestamp).toLocaleString()}</div>
                                `;
                                fragment.appendChild(messageEl);
                            });
                            container.insertBefore(fragment, container.firstChild);
                            messageOffset += 10;
                        } catch (err) {
                            console.error('Error loading messages:', err);
                        } finally {
                            isLoadingMessages = false;
                        }
                    };

                    // Throttled scroll handler
                    const handleScroll = throttle(() => {
                        if (container.scrollTop === 0) {
                            loadMessages();
                        }
                    }, 1000);
                    container.addEventListener('scroll', handleScroll);

                    // Handle new messages
                    window.addEventListener('newMessage', (e) => {
                        const msg = e.detail;
                        if (msg.sender_id === selectedChatUserId || msg.recipient_id === selectedChatUserId) {
                            const messageEl = document.createElement('div');
                            messageEl.className = 'message';
                            messageEl.innerHTML = `
                                <div class="message-sender">${msg.sender_nickname}</div>
                                <div class="message-content">${msg.content}</div>
                                <div class="message-timestamp">${new Date(msg.timestamp).toLocaleString()}</div>
                            `;
                            container.appendChild(messageEl);
                            container.scrollTop = container.scrollHeight;
                        }
                    });

                    // Handle message history
                    window.addEventListener('messageHistory', (e) => {
                        const history = e.detail;
                        container.innerHTML = history.map(msg => `
                            <div class="message">
                                <div class="message-sender">${msg.sender_nickname}</div>
                                <div class="message-content">${msg.content}</div>
                                <div class="message-timestamp">${new Date(msg.timestamp).toLocaleString()}</div>
                            </div>
                        `).join('');
                        container.scrollTop = container.scrollHeight;
                    });

                    // Send message
                    document.getElementById('send-message-btn').addEventListener('click', () => {
                        const input = document.getElementById('message-input');
                        if (ws && input.value.trim() && selectedChatUserId) {
                            ws.sendMessage({ content: input.value, recipient_id: selectedChatUserId });
                            input.value = '';
                        }
                    });
                }
            },
            '/notifications': {
                template: `
                    <h2 class="text-2xl font-bold mb-4">Notifications</h2>
                    <div id="notification-container"></div>
                `,
                protected: true,
                init: () => {
                    window.addEventListener('newNotification', (e) => {
                        const notif = e.detail;
                        const container = document.getElementById('notification-container');
                        const notifEl = document.createElement('div');
                        notifEl.className = 'notification';
                        notifEl.textContent = notif.content;
                        container.appendChild(notifEl);
                        setTimeout(() => notifEl.remove(), 5000);
                    });
                }
            }
        };

        // Navigation
        function navigate(path) {
            if (!token && routes[path]?.protected) {
                path = '/login';
            }
            window.history.pushState({}, '', path);
            render();
        }

        // Render
        function render() {
            const path = window.location.pathname || '/';
            const route = routes[path] || routes['/login'];
            if (path.startsWith('/posts/') && !route.template) {
                route.template = routes['/posts/:id'].template;
                route.protected = true;
                route.init = routes['/posts/:id'].init;
            }
            const app = document.getElementById('app');
            app.innerHTML = route.template;
            updateNavbar();
            updateSidebar();
            if (route.init) route.init();
        }

        // Update Navbar
        function updateNavbar() {
            const navLinks = document.getElementById('nav-links');
            if (token) {
                navLinks.innerHTML = `
                    <a href="/home" class="text-white hover:underline">Home</a>
                    <a href="/posts" class="text-white hover:underline">Posts</a>
                    <a href="/messages" class="text-white hover:underline">Messages</a>
                    <a href="/notifications" class="text-white hover:underline">Notifications</a>
                    <button id="logout-btn" class="text-white hover:underline">Logout</button>
                `;
                document.getElementById('logout-btn').addEventListener('click', () => {
                    localStorage.removeItem('token');
                    token = null;
                    nickname = '';
                    if (ws) {
                        ws.connection.close();
                        ws = null;
                    }
                    navigate('/login');
                });
            } else {
                navLinks.innerHTML = `
                    <a href="/login" class="text-white hover:underline">Login</a>
                    <a href="/signup" class="text-white hover:underline">Sign Up</a>
                `;
            }
        }

        // Update Sidebar
        function updateSidebar() {
            const sidebar = document.getElementById('sidebar');
            const userList = document.getElementById('user-list');
            if (token) {
                sidebar.classList.remove('hidden');
                const fetchUsers = async () => {
                    try {
                        const response = await fetch('/api/users', {
                            headers: { 'Authorization': `Bearer ${token}` },
                        });
                        const users = await response.json();
                        userList.innerHTML = users.map(user => `
                            <div class="p-2 mb-2 bg-gray-100 rounded cursor-pointer hover:bg-gray-200" data-user-id="${user.id}">
                                <span class="font-bold">${user.nickname}</span>
                                <span class="text-sm ${user.online_status ? 'text-green-500' : 'text-red-500'}">
                                    ${user.online_status ? 'Online' : 'Offline'}
                                </span>
                            </div>
                        `).join('');
                        userList.querySelectorAll('[data-user-id]').forEach(el => {
                            el.addEventListener('click', () => {
                                selectedChatUserId = el.dataset.userId;
                                messageOffset = 0;
                                document.getElementById('message-container').innerHTML = '';
                                navigate('/messages');
                            });
                        });
                    } catch (err) {
                        console.error('Error fetching users:', err);
                    }
                };
                fetchUsers();
            } else {
                sidebar.classList.add('hidden');
                userList.innerHTML = '';
            }
        }

        // WebSocket User Status
        window.addEventListener('userStatus', (e) => {
            const { user_id, nickname, online_status } = e.detail;
            const userEl = document.querySelector(`[data-user-id="${user_id}"]`);
            if (userEl) {
                userEl.querySelector('span:last-child').textContent = online_status ? 'Online' : 'Offline';
                userEl.querySelector('span:last-child').className = `text-sm ${online_status ? 'text-green-500' : 'text-red-500'}`;
            }
        });

        // Handle navigation
        window.addEventListener('popstate', render);
        document.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link && link.href) {
                e.preventDefault();
                const path = new URL(link.href).pathname;
                navigate(path);
            }
        });

        // Initialize
        if (token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                userId = payload.user_id || '123';
                nickname = payload.nickname || 'User';
                ws = new MessageWebSocket(userId);
            } catch (err) {
                console.error('Error decoding JWT:', err);
                localStorage.removeItem('token');
                token = null;
                nickname = '';
                navigate('/login');
            }
        }
        render();
    </script>
</body>
</html>